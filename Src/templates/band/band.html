<!DOCTYPE html>
<html lang="ja">
<head>
  {% include "head.html" %}

  <title>{{ band.name }} のスケジュール</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/band/band.css') }}">
</head>
<body>
  {% include "header.html" %}

  <div class="band-container">
    <div class="band-header">
      <h1>{{ band.name }}</h1>
      <div class="band-details">
        <p>
          <span class="label">期間:</span> {{ band.start_date.strftime('%Y/%m/%d') }} - {{ band.end_date.strftime('%Y/%m/%d') }}
        </p>
        <p>
          <span class="label">時間:</span> {{ band.start_time.strftime('%H:%M') }} - {{ band.end_time.strftime('%H:%M') }}
        </p>
      </div>
    </div>

    <p class="description">
      各時間帯に参加可能なメンバーの人数です。色が濃いほど多くのメンバーが参加できます。<br>
      （各マスにカーソルを合わせるかタップすると、参加メンバー名が表示されます）
    </p>

    <div class="table-wrapper">
      <table class="schedule-table">
        <thead>
          <tr>
            <th class="corner-cell">時間</th>
            {% for day in dates %}
            {% set weekdays = ['月', '火', '水', '木', '金', '土', '日'] %}
            <th data-date="{{ day.isoformat() }}">
              {{ day.strftime('%m/%d') }}<br>
              {{ weekdays[day.weekday()] }}
            </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for hour in times %}
          <tr>
            <td class="time-label">
              <span class="time-full">{{ "%02d:00" | format(hour) }}</span>
              <span class="time-short">{{ hour }}</span>
            </td>
            {% for day in dates %}
              {% set count = schedules_agg.get(day.isoformat(), {}).get(hour, 0) %}
              {# 参加メンバーのリストを取得 #}
              {% set members_list = schedules_detail.get(day.isoformat(), {}).get(hour, []) %}
              <td
                data-count="{{ count }}"
                {# メンバーリストが空でなければ data-members 属性を追加 #}
                {% if members_list %}
                  data-members="{{ members_list|join(',') }}"
                {% endif %}
                title="{{ count }} / {{ total_members }} 人"
              >
                {% if count > 0 %}
                  <span>{{ count }}</span>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if user_comments %}
    <div class="comments-section">
      <h2>メンバーの備考</h2>
      <ul class="comment-list">
        {% for item in user_comments %}
        <li class="comment-item">
          <p class="comment-author">{{ item.name }}</p>
          <div class="comment-body">{{ item.comment }}</div>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <a href="{{ url_for('bands_list') }}" class="back-link">バンド一覧に戻る</a>

    <div class="band-footer-actions">
      {# 現在のユーザーがバンドの作成者である場合 #}
      {% if is_creator %}
        <a href="{{ url_for('band_edit', token=band.token) }}" class="btn-action btn-edit">
          バンド情報を編集する
        </a>
        <form action="{{ url_for('band_delete') }}" method="POST" id="delete-band-form">
          <input type="hidden" name="token" value="{{ band.token }}">
          <button type="submit" class="btn-action btn-delete">
            バンドを削除する
          </button>
        </form>
      {% else %}
        {# 作成者以外のメンバーである場合 #}
        <form action="{{ url_for('band_leave') }}" method="POST">
          <input type="hidden" name="token" value="{{ band.token }}">
          <button type="submit" class="btn-action btn-leave">
            バンドから退出する
          </button>
        </form>
      {% endif %}
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/band.js') }}"></script>
  <div id="tooltip" class="schedule-tooltip"></div> <!-- ツールチップ用のdiv -->
</body>
</html>